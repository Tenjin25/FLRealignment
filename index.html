<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>FL Political Realignment Map (2008-2024)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .map-container { height: 100vh; display: flex; }
    #map { flex: 1; height: 100vh; }
    .sidebar { width: 300px; background: #2d2d2d; border-left: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; }
    .controls { padding: 20px; background: #2d2d2d; border-bottom: 1px solid #444; }
    .control-group { margin-bottom: 20px; }
    .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #e0e0e0; font-size: 14px; }
    select { width: 100%; padding: 10px; background: #3d3d3d; border: 1px solid #555; border-radius: 4px; color: #e0e0e0; font-size: 14px; }
    .layer-controls { display: flex; flex-direction: column; gap: 12px; }
    .layer-control { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #3d3d3d; border-radius: 4px; border: 1px solid #555; }
    .results-container { flex: 1; overflow-y: auto; padding: 20px; }
    .county-result { background: #3d3d3d; border: 1px solid #555; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .county-name { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #fff; border-bottom: 1px solid #555; padding-bottom: 8px; }
    .vote-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .candidate-info { flex: 1; }
    .candidate-name { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
    .vote-count { font-size: 13px; color: #b0b0b0; }
    .vote-percentage { font-size: 24px; font-weight: 700; min-width: 60px; text-align: right; }
    .democrat { color: #2196F3; }
    .republican { color: #F44336; }
    .winner { border-left: 4px solid; padding-left: 12px; }
    .winner.democrat { border-left-color: #2196F3; }
    .winner.republican { border-left-color: #F44336; }
    .margin-info { font-size: 14px; color: #b0b0b0; text-align: center; font-style: italic; border-top: 1px solid #555; padding-top: 8px; }
    .status { position: fixed; bottom: 20px; left: 20px; background: rgba(45,45,45,0.95); color: #e0e0e0; padding: 12px 16px; border-radius: 4px; border: 1px solid #555; font-size: 14px; max-width: 300px; z-index: 1000; }
    .legend { position: fixed; top: 20px; right: 20px; background: rgba(45,45,45,0.95); padding: 16px; border-radius: 4px; border: 1px solid #555; font-size: 12px; color: #e0e0e0; z-index: 1000; }
    .legend-title { font-weight: 700; margin-bottom: 12px; font-size: 14px; color: #fff; }
    .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
    .legend-color { width: 20px; height: 15px; margin-right: 8px; border-radius: 2px; border: 1px solid #666; }
    .no-results { text-align: center; color: #999; font-style: italic; padding: 40px 20px; background: #3d3d3d; border-radius: 8px; border: 1px solid #555; }
    @media (max-width: 768px) { .sidebar { width: 100%; height: 50vh; } .map-container { flex-direction: column; } #map { height: 50vh; } }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map"></div>
    <div class="sidebar">
      <div class="controls">
        <div class="control-group">
          <label for="year-select">Election Year:</label>
          <select id="year-select"></select>
        </div>
        <div class="control-group">
          <label for="contest-select">Contest:</label>
          <select id="contest-select"></select>
        </div>
        <div class="control-group">
          <label>Map Layers:</label>
          <div class="layer-controls">
            <div class="layer-control"><label for="layer-counties">County Boundaries</label><input type="checkbox" id="layer-counties" checked></div>
            <div class="layer-control"><label for="layer-congressional">Congressional Districts</label><input type="checkbox" id="layer-congressional"></div>
            <div class="layer-control"><label for="layer-state-house">State House Districts</label><input type="checkbox" id="layer-state-house"></div>
            <div class="layer-control"><label for="layer-state-senate">State Senate Districts</label><input type="checkbox" id="layer-state-senate"></div>
          </div>
        </div>
      </div>
      <div class="results-container"><div id="results"></div></div>
    </div>
  </div>
  <div class="legend">
    <div class="legend-title">Vote Share</div>
    <div class="legend-item"><div class="legend-color" style="background:#0d47a1;"></div><span>80%+ Democratic</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#1976d2;"></div><span>60-80% Democratic</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#42a5f5;"></div><span>50-60% Democratic</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#e1bee7;"></div><span>50-60% Republican</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#e57373;"></div><span>60-80% Republican</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#c62828;"></div><span>80%+ Republican</span></div>
  </div>
  <div id="status" class="status"></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWJpbmdoYW0yNiIsImEiOiJjbTN6Njc0MnEwYjdtMmlvaXE3bTJ2M29yIn0.wKfzJEglrTqCrnvF7qLDVw';
    let map, countyData, congressionalData, stateHouseData, stateSenateData, electionData;
    function normalizeCountyName(name) {
      if (!name) return name;
      return name.replace(/St[\.]?\s*Lucie/i, 'St Lucie').replace(/St[\.]?\s*Johns/i, 'St Johns').replace(/\./g, '').replace(/\s+/g, ' ').trim();
    }
    function displayCountyName(name) {
      if (!name) return name;
      const displayMap = { 'St. Lucie': 'St. Lucie', 'St. Johns': 'St. Johns', 'Miami-Dade': 'Miami-Dade', 'DeSoto': 'DeSoto' };
      return displayMap[name] || name;
    }
    function populateYearDropdown() {
      const yearSelect = document.getElementById('year-select');
      yearSelect.innerHTML = '';
      if (electionData) {
        const years = Object.keys(electionData).sort();
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
        if (years.length > 0) yearSelect.value = years[years.length - 1];
      }
    }
    function populateContestDropdown() {
      const contestSelect = document.getElementById('contest-select');
      const year = document.getElementById('year-select').value;
      contestSelect.innerHTML = '';
      const availableContests = new Set();
      if (electionData && electionData[year]) {
        Object.keys(electionData[year]).forEach(contest => {
          const hasData = Object.values(electionData[year][contest]).some(countyData => countyData.dem_votes > 0 || countyData.rep_votes > 0);
          if (hasData) availableContests.add(contest);
        });
      }
      availableContests.forEach(contest => {
        const option = document.createElement('option');
        option.value = contest;
        option.textContent = formatContestName(contest, year);
        contestSelect.appendChild(option);
      });
      if (contestSelect.options.length > 0) contestSelect.value = contestSelect.options[0].value;
    }
    function addCountyLayers() {
      map.addLayer({ id: 'counties-fill', type: 'fill', source: 'counties', paint: { 'fill-color': [ 'case', ['==', ['get', 'dem_percentage'], null], '#666666', [ 'interpolate', ['linear'], ['get', 'dem_percentage'], 0, '#c62828', 40, '#e57373', 45, '#e1bee7', 50, '#e1bee7', 55, '#42a5f5', 70, '#1976d2', 100, '#0d47a1' ] ], 'fill-opacity': 0.7 } });
      map.addLayer({ id: 'counties-border', type: 'line', source: 'counties', paint: { 'line-color': '#fff', 'line-width': 1 } });
    }
    function addCongressionalLayers() {
      map.addLayer({ id: 'congressional-fill', type: 'fill', source: 'congressional', paint: { 'fill-color': 'transparent', 'fill-opacity': 0 } });
      map.addLayer({ id: 'congressional-border', type: 'line', source: 'congressional', paint: { 'line-color': '#ffeb3b', 'line-width': 2 } });
    }
    function addStateHouseLayers() {
      map.addLayer({ id: 'state-house-fill', type: 'fill', source: 'state-house', paint: { 'fill-color': 'transparent', 'fill-opacity': 0 } });
      map.addLayer({ id: 'state-house-border', type: 'line', source: 'state-house', paint: { 'line-color': '#ff9800', 'line-width': 2 } });
    }
    function addStateSenateLayers() {
      map.addLayer({ id: 'state-senate-fill', type: 'fill', source: 'state-senate', paint: { 'fill-color': 'transparent', 'fill-opacity': 0 } });
      map.addLayer({ id: 'state-senate-border', type: 'line', source: 'state-senate', paint: { 'line-color': '#9c27b0', 'line-width': 2 } });
    }
    function setupEventListeners() {
      document.getElementById('year-select').addEventListener('change', updateVisualization);
      document.getElementById('contest-select').addEventListener('change', updateVisualization);
      document.getElementById('layer-counties').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('counties-fill', 'visibility', visibility);
        map.setLayoutProperty('counties-border', 'visibility', visibility);
      });
      document.getElementById('layer-congressional').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('congressional-fill', 'visibility', visibility);
        map.setLayoutProperty('congressional-border', 'visibility', visibility);
      });
      document.getElementById('layer-state-house').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('state-house-fill', 'visibility', visibility);
        map.setLayoutProperty('state-house-border', 'visibility', visibility);
      });
      document.getElementById('layer-state-senate').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('state-senate-fill', 'visibility', visibility);
        map.setLayoutProperty('state-senate-border', 'visibility', visibility);
      });
      map.on('click', 'counties-fill', function(e) {
        const county = e.features[0].properties;
        showCountyPopup(e.lngLat, county);
      });
      map.on('mouseenter', 'counties-fill', function() { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'counties-fill', function() { map.getCanvas().style.cursor = ''; });
    }
    function updateVisualization() {
      const year = document.getElementById('year-select').value;
      const contest = document.getElementById('contest-select').value;
      populateContestDropdown();
      if (!electionData || !electionData[year] || !electionData[year][contest]) {
        setStatus(`No data available for ${contest} in ${year}`);
        updateSidebar([]);
        updateMapColors({});
        return;
      }
      const contestData = electionData[year][contest];
      const results = [];
      if (countyData && countyData.features) {
        countyData.features.forEach(feature => {
          const countyName = normalizeCountyName(feature.properties.NAMELSAD || feature.properties.NAME);
          const countyResults = contestData[countyName];
          if (countyResults && (countyResults.dem_votes > 0 || countyResults.rep_votes > 0)) {
            const totalVotes = countyResults.dem_votes + countyResults.rep_votes;
            const demPercentage = (countyResults.dem_votes / totalVotes) * 100;
            const repPercentage = (countyResults.rep_votes / totalVotes) * 100;
            feature.properties.dem_percentage = demPercentage;
            feature.properties.rep_percentage = repPercentage;
            feature.properties.dem_votes = countyResults.dem_votes;
            feature.properties.rep_votes = countyResults.rep_votes;
          } else {
            feature.properties.dem_percentage = null;
            feature.properties.rep_percentage = null;
            feature.properties.dem_votes = 0;
            feature.properties.rep_votes = 0;
          }
        });
      }
      map.getSource('counties').setData(countyData);
        updateSidebar(countyData.features.map(feature => ({
          county: displayCountyName(normalizeCountyName(feature.properties.NAMELSAD || feature.properties.NAME)),
          demVotes: feature.properties.dem_votes,
          repVotes: feature.properties.rep_votes,
          demPercentage: feature.properties.dem_percentage,
          repPercentage: feature.properties.rep_percentage,
          winner: feature.properties.dem_percentage > feature.properties.rep_percentage ? 'democrat' : 'republican',
          margin: Math.abs(feature.properties.dem_percentage - feature.properties.rep_percentage),
          demCandidate: feature.properties.dem_candidate,
          repCandidate: feature.properties.rep_candidate
        })));
      updateMapColors(contestData);
      const statewideData = calculateStatewideResults(contestData);
      if (statewideData.totalVotes > 0) {
        const demPct = (statewideData.demVotes / statewideData.totalVotes) * 100;
        const repPct = (statewideData.repVotes / statewideData.totalVotes) * 100;
        setStatus(`Applied statewide contest: ${formatContestName(contest, year)} ${year} (${demPct.toFixed(1)}% D, ${repPct.toFixed(1)}% R)`);
      } else {
        setStatus(`No data available for ${formatContestName(contest, year)} ${year}`);
      }
    }
    function calculateStatewideResults(contestData) {
      let totalDemVotes = 0, totalRepVotes = 0;
      Object.values(contestData).forEach(county => {
        if (county.dem_votes && county.rep_votes) {
          totalDemVotes += county.dem_votes;
          totalRepVotes += county.rep_votes;
        }
      });
      return { demVotes: totalDemVotes, repVotes: totalRepVotes, totalVotes: totalDemVotes + totalRepVotes };
    }
    function updateSidebar(results) {
      const resultsContainer = document.getElementById('results');
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">No election results available for this selection.</div>';
        return;
      }
      results.sort((a, b) => a.margin - b.margin);
      resultsContainer.innerHTML = results.map(result => {
        const demCandidateName = result.demCandidate ? `${result.demCandidate} (D)` : 'Democratic Candidate';
        const repCandidateName = result.repCandidate ? `${result.repCandidate} (R)` : 'Republican Candidate';
        return `<div class="county-result"><div class="county-name">${result.county}</div><div class="vote-info ${result.winner}"><div class="candidate-info"><div class="candidate-name ${result.winner === 'democrat' ? 'democrat' : ''}">${demCandidateName}</div><div class="vote-count">${result.demVotes.toLocaleString()} votes</div></div><div class="vote-percentage democrat">${result.demPercentage.toFixed(1)}%</div></div><div class="vote-info ${result.winner}"><div class="candidate-info"><div class="candidate-name ${result.winner === 'republican' ? 'republican' : ''}">${repCandidateName}</div><div class="vote-count">${result.repVotes.toLocaleString()} votes</div></div><div class="vote-percentage republican">${result.repPercentage.toFixed(1)}%</div></div><div class="margin-info">Margin: ${result.margin.toFixed(1)}%</div></div>`;
      }).join('');
    }
    function updateMapColors(contestData) { /* map colors auto-update */ }
    function showCountyPopup(lngLat, county) {
      const year = document.getElementById('year-select').value;
      const contest = document.getElementById('contest-select').value;
      let popupContent = `<h3>${displayCountyName(county.NAMELSAD || county.NAME)}</h3>`;
      if (county.dem_votes > 0 || county.rep_votes > 0) {
        const totalVotes = county.dem_votes + county.rep_votes;
        const demPct = (county.dem_votes / totalVotes * 100).toFixed(1);
        const repPct = (county.rep_votes / totalVotes * 100).toFixed(1);
        popupContent += `<p><strong>${formatContestName(contest, year)} ${year}</strong></p><p>Democratic: ${county.dem_votes.toLocaleString()} (${demPct}%)</p><p>Republican: ${county.rep_votes.toLocaleString()} (${repPct}%)</p><p>Total Votes: ${totalVotes.toLocaleString()}</p>`;
      } else {
        popupContent += `<p>No data available for ${formatContestName(contest, year)} ${year}</p>`;
      }
      new mapboxgl.Popup().setLngLat(lngLat).setHTML(popupContent).addTo(map);
    }
    function formatContestName(contest, year) {
      const contestNames = { 'US_PRESIDENT': 'Presidential Election', 'US_SENATE': 'US Senate Election', 'GOVERNOR': 'Gubernatorial Election' };
      return contestNames[contest] || contest;
    }
    function setStatus(message) { document.getElementById('status').textContent = message; }
    function init() {
      map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/dark-v10', center: [-82.4, 28.0], zoom: 6 });
      map.on('load', function() { loadData(); setupEventListeners(); });
    }
    async function loadData() {
      try {
        setStatus('Loading data...');
        const [countyResponse, congressionalResponse, stateHouseResponse, stateSenateResponse, electionResponse] = await Promise.all([
          fetch('./data/fl_counties.geojson'),
          fetch('./data/fl_congressional_districts.geojson'),
          fetch('./data/fl_state_house_districts.geojson'),
          fetch('./data/fl_state_senate_districts.geojson'),
          fetch('./data/fl_election.json')
        ]);
        countyData = await countyResponse.json();
        congressionalData = await congressionalResponse.json();
        stateHouseData = await stateHouseResponse.json();
        stateSenateData = await stateSenateResponse.json();
        electionData = await electionResponse.json();
        map.addSource('counties', { type: 'geojson', data: countyData });
        map.addSource('congressional', { type: 'geojson', data: congressionalData });
        map.addSource('state-house', { type: 'geojson', data: stateHouseData });
        map.addSource('state-senate', { type: 'geojson', data: stateSenateData });
        addCountyLayers();
        addCongressionalLayers();
        addStateHouseLayers();
        addStateSenateLayers();
        map.setLayoutProperty('counties-fill', 'visibility', 'visible');
        map.setLayoutProperty('counties-border', 'visibility', 'visible');
        map.setLayoutProperty('congressional-fill', 'visibility', 'none');
        map.setLayoutProperty('congressional-border', 'visibility', 'none');
        map.setLayoutProperty('state-house-fill', 'visibility', 'none');
        map.setLayoutProperty('state-house-border', 'visibility', 'none');
        map.setLayoutProperty('state-senate-fill', 'visibility', 'none');
        map.setLayoutProperty('state-senate-border', 'visibility', 'none');
        setStatus('Data loaded successfully');
        populateYearDropdown();
        populateContestDropdown();
        updateVisualization();
      } catch (error) {
        console.error('Error loading data:', error);
        setStatus('Error loading data: ' + error.message);
      }
    }
    window.onload = init;
  </script>
</body>
</html>
