<!DOCTYPE html>
<html>
<head>
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <meta charset='utf-8'>
    <title>FL Political Realignment Map (2008-2024)</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>
    <meta property="og:title" content="FL Political Realignment Map (2008-2024)">
    <meta property="og:description" content="Interactive visualization of Florida's political trends from 2008 to 2024, showing county-level voting patterns.">
    <meta property="og:image" content="preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet'>
    <style>
html, body {
  height: 100vh;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
  overflow: hidden;
}
#map {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  min-height: 0;
  background: #f0f4f8;
  z-index: 1;
}

.sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 400px;
  height: 100vh;
  background: #fff;
  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
  border-left: 1px solid #e5e7eb;
  overflow-y: auto;
  z-index: 1002;
  transition: width 0.3s cubic-bezier(.4,0,.2,1);
}
.sidebar.minimized {
  width: 0 !important;
  min-width: 0 !important;
  max-width: 0 !important;
  opacity: 0 !important;
  pointer-events: none !important;
  overflow: hidden !important;
}
.sidebar.minimized .sidebar-content {
  display: none !important;
}
.sidebar.minimized .sidebar-header {
  display: none !important;
}
.sidebar-toggle-btn {
  position: fixed;
  top: 32px;
  left: 32px;
  z-index: 2000;
  width: 38px;
  height: 38px;
  background: #2563eb;
  color: white;
  border: 1px solid #1d4ed8;
  border-radius: 8px;
  font-size: 22px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  cursor: pointer;
  transition: all 0.2s;
}
.sidebar.minimized .sidebar-toggle-btn {
  display: flex !important;
}
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}
.sidebar-header h3 {
  margin: 0;
  font-size: 1.1rem;
  color: #374151;
}
.sidebar-content {
  padding: 20px;
}
.minimize-btn {
  background: #2563eb;
  border: 1px solid #1d4ed8;
  border-radius: 6px;
  width: 30px;
  height: 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  color: white;
  transition: all 0.2s ease;
}
.minimize-btn:hover {
  background: #1d4ed8;
  border-color: #1e40af;
  transform: scale(1.05);
}

/* Main Controls */
.main-controls {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  z-index: 1000;
  min-width: 380px;
  max-width: 420px;
  transition: all 0.3s ease;
}
.main-controls.minimized {
  min-width: 60px;
  max-width: 60px;
  padding: 15px;
}
.main-controls.minimized .controls-content {
  display: none;
}
.controls-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.controls-header h3 {
  margin: 0;
  color: #1f2937;
  font-weight: 600;
  font-size: 16px;
}
.controls-content {
  position: relative;
}
.analysis-mode {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.mode-toggle {
  flex: 1;
  padding: 8px;
  text-align: center;
  border: 2px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
  font-weight: 500;
}
.mode-toggle.active {
  background: #3498db;
  color: white;
  border-color: #3498db;
}
.analysis-mode {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  background: #f3f4f6;
  border-radius: 8px;
  padding: 4px;
}
.mode-toggle {
  flex: 1;
  text-align: center;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  color: #6b7280;
}
.mode-toggle.active {
  background: #2563eb;
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
}
.mode-toggle:hover:not(.active) {
  background: #e5e7eb;
  color: #374151;
}
.view-toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  background: #f3f4f6;
  border-radius: 8px;
  padding: 4px;
}
.control-group {
  margin-bottom: 16px;
}
.control-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #374151;
}
.control-group select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  font-size: 14px;
}

/* Legend */
.legend {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  z-index: 1000;
  min-width: 250px;
  border: 1px solid #e5e7eb;
}
.legend.minimized .legend-content {
  display: none;
}
.legend-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
  border-radius: 12px 12px 0 0;
}
.legend-header h4 {
  margin: 0;
  font-size: 1rem;
  color: #374151;
}
.legend-content {
  padding: 16px 20px;
}
.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
}
.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 3px;
  margin-right: 10px;
  flex-shrink: 0;
}

/* County Details */
.county-details {
  margin-bottom: 20px;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e7eaf3;
}
.county-details h4 {
  margin: 0 0 12px 0;
  color: #374151;
}
.statewide-results {
  margin-bottom: 20px;
  padding: 16px;
  background: #f0f9ff;
  border-radius: 8px;
  border: 1px solid #0ea5e9;
}
.statewide-results h4 {
  margin: 0 0 12px 0;
  color: #0369a1;
}

/* Statewide Results */
.statewide-results {
  border-top: 1px solid #e5e7eb;
  padding-top: 20px;
  margin-bottom: 20px;
}
.statewide-results h4 {
  margin: 0 0 15px 0;
  color: #1f2937;
  font-size: 16px;
  font-weight: 600;
}
.statewide-margin {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
}
.margin-text {
  font-weight: 600;
  font-size: 16px;
}
.margin-details {
  font-size: 13px;
  color: #64748b;
  margin-top: 5px;
}

.findings-section {
  margin-bottom: 20px;
}
.findings-section h4 {
  margin: 0 0 16px 0;
  color: #374151;
}
.finding-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.finding-card h5 {
  margin: 0 0 12px 0;
  color: #1f2937;
  font-size: 15px;
  font-weight: 600;
  border-bottom: 2px solid #3b82f6;
  padding-bottom: 6px;
}
.finding-card p {
  margin: 8px 0;
  font-size: 13px;
  line-height: 1.5;
  color: #374151;
}
.metric {
  background: #dbeafe;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #1e40af;
}

/* End of styles */

.metric {
  background: #eff6ff;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 600;
  color: #1d4ed8;
  display: inline-block;
  margin: 2px;
}

/* Status panel */
.status-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  border: 1px solid #e5e7eb;
  z-index: 1000;
  max-width: 300px;
}

/* --- NC-style Sidebar CSS Patch --- */
.sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 400px;
  height: 100vh;
  background: #fff;
  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
  border-left: 1px solid #e5e7eb;
  overflow-y: auto;
  z-index: 1002;
  transition: width 0.3s cubic-bezier(.4,0,.2,1);
}
.sidebar.minimized {
  width: 0 !important;
  min-width: 0 !important;
  max-width: 0 !important;
  opacity: 0 !important;
  pointer-events: none !important;
  overflow: hidden !important;
}
.sidebar.minimized .sidebar-content {
  display: none !important;
}
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}
.sidebar-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}
.sidebar-header .minimize-btn {
  color: #fff;
  background: #2563eb;
  border: none;
  font-size: 32px;
  width: 48px;
  height: 48px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Show floating expand button when sidebar is minimized */
.sidebar.minimized ~ #sidebar-float-toggle {
  display: flex !important;
}
/* Floating expand/collapse button for sidebar (top right, larger, shows + when minimized and - when open) */
#sidebar-float-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10001;
  width: 48px;
  height: 48px;
  background: #2563eb;
  color: #fff;
  border: none;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  font-size: 32px;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
    </style>
</head>
<body>
    <div id="map" style="position:relative;width:100%;height:100%;">
        <canvas id="countySwingLayer" width="1920" height="1080" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;"></canvas>
    </div>
    
    <!-- Hover Tooltip -->
    <div id="hover-tooltip" class="hover-tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-trends"></div>
    </div>

    <!-- Main Controls Dropdown (Contest Selector) -->
    <div class="main-controls" id="main-controls">
        <div class="controls-header">
            <h3>🗳️ FL Political Contests</h3>
            <button class="minimize-btn" onclick="toggleMainControls()" id="controls-minimize-btn">−</button>
        </div>
        <div class="controls-content" id="controls-content">
            <div class="analysis-mode">
                <div class="mode-toggle active" id="county-mode" onclick="setAnalysisMode('county')">County Results</div>
                <div class="mode-toggle" id="district-mode" onclick="setAnalysisMode('district')">District Analysis</div>
            </div>
            <div class="control-group">
                <label>🗺️ Map View:</label>
                <div class="view-toggle">
                    <div class="mode-toggle active" id="counties-view" onclick="setMapView('counties')">Counties</div>
                    <div class="mode-toggle" id="districts-view" onclick="setMapView('districts')">Congress</div>
                </div>
                <div class="view-toggle" style="margin-top: 8px;">
                    <div class="mode-toggle" id="state-house-view" onclick="setMapView('state_house')">State House</div>
                    <div class="mode-toggle" id="state-senate-view" onclick="setMapView('state_senate')">State Senate</div>
                </div>
                <!-- 2000 VTDs option (hidden until data is loaded) -->
                <div class="view-toggle" style="margin-top: 8px; display: none;" id="vtds-2000-section">
                    <div class="mode-toggle" id="vtds-2000-view" onclick="setMapView('vtds_2000')">2000 Precincts</div>
                </div>
            </div>
            <div class="control-group">
                <label>📊 Contest Type:</label>
                <select id="contestSelect">
                    <option value="">Select a Contest...</option>
                </select>
            </div>
            <!-- Add missing share-container for Share Map button -->
            <div id="share-container" style="margin-top:16px;"></div>
        </div>
    </div>

    <!-- Sidebar for County Details and Analysis -->
    <div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebar-header" style="position:relative;">
    <h3>📊 County Analysis</h3>
    <button class="minimize-btn sidebar-toggle-btn" onclick="toggleSidebar()" id="sidebar-minimize-btn" style="position:absolute;top:20px;right:20px;background:#2563eb;color:#fff;border:none;font-size:32px;width:48px;height:48px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1003;">−</button>
  </div>
  <div class="sidebar-content">
    <div class="county-details" id="county-details" style="display: none;">
      <h4 id="county-name">Select a County</h4>
      <div id="county-info-content">
        Click on any county to see detailed election results and analysis.
      </div>
    </div>
    <div style="margin-bottom: 16px;">
      <label for="county-search" style="font-weight:600;">Search County:</label>
      <input type="text" id="county-search" placeholder="Type to search..." style="width:100%;padding:8px;border-radius:6px;margin-top:6px;margin-bottom:6px;" />
    </div>
    <div class="statewide-results" id="statewide-results">
      <h4 id="statewide">🏛️ Florida Statewide</h4>
      <div id="statewide-content">
        <p>Select a contest to see statewide results and margin.</p>
      </div>
    </div>
    <div class="findings-section">
      <h4>🔍 Research Findings</h4>
      <div class="finding-card">
        <h5>Miami-Dade County - Historic Republican Flip</h5>
        <p><strong>Dramatic Shift:</strong> Once a reliable Democratic stronghold, Miami-Dade flipped Republican for the first time in decades.</p>
        <p><strong>Key Demographics:</strong> Growing Cuban-American and Venezuelan-American populations, plus Hispanic voter shifts. <span class="metric">2020: D+7.3%</span> &rarr; <span class="metric">2024: R+11.4%</span></p>
        <p><strong>Geography:</strong> Republican gains across both urban core and suburban areas (Kendall, Westchester, Hialeah).</p>
        <p><strong>Impact:</strong> Massive <span class="metric">18.7-point</span> swing represents one of the largest county-level political realignments in recent Florida history.</p>
      </div>
      <div class="finding-card">
        <h5>Orange County - Suburban Evolution</h5>
        <p><strong>Transformation:</strong> Orange County has transitioned from swing county to Democratic-leaning due to rapid population growth and demographic changes.</p>
        <p><strong>Metro Growth:</strong> Orlando expansion and younger, more diverse voter registration. <span class="metric">Population: +15.1% (2010-2020)</span></p>
        <p><strong>Electoral Pattern:</strong> Consistent Democratic performance in recent cycles. <span class="metric">2020: D+8.8%</span> &rarr; <span class="metric">2024: D+6.4%</span></p>
        <p><strong>Strategic Importance:</strong> Essential to statewide Democratic competitiveness and I-4 corridor control.</p>
      </div>
      <div class="finding-card">
        <h5>Statewide Patterns &amp; I-4 Corridor</h5>
        <p><strong>Rural-Urban Divide:</strong> Growing polarization between urban coastal counties and rural interior counties.</p>
        <p><strong>I-4 Corridor:</strong> Tampa-Orlando corridor remains the key battleground determining statewide outcomes. <span class="metric">Hillsborough</span>, <span class="metric">Orange</span>, <span class="metric">Seminole</span> counties pivotal.</p>
        <p><strong>Registration Trends:</strong> Unaffiliated voter growth creating volatile election dynamics across swing counties.</p>
        <p><strong>Demographics:</strong> Hispanic population growth in Central Florida reshaping electoral map.</p>
      </div>
    </div>
  </div>
  <div style="padding: 16px 0; text-align: center; color: #888; font-size: 15px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
    Created by Shamar Davis
  </div>
</div>
    <!-- Floating expand/collapse button for sidebar (top right, larger) -->
    <button id="sidebar-float-toggle" style="position:fixed;top:20px;right:20px;z-index:10001;width:48px;height:48px;background:#2563eb;color:#fff;border:none;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;">+</button>

    <!-- Modern legend block (NC map style) -->
    <div class="legend" id="legend">
      <div class="legend-header">
        <h4>Political Categories</h4>
        <button class="minimize-btn" onclick="toggleLegend()" id="legend-minimize-btn">−</button>
      </div>
      <div class="legend-content" id="legend-content">
        <div class="legend-item"><div class="legend-color" style="background: #67000d;"></div>Annihilation Republican (40%+)</div>
        <div class="legend-item"><div class="legend-color" style="background: #a50f15;"></div>Dominant Republican (30-40%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #cb181d;"></div>Stronghold Republican (20-30%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #ef3b2c;"></div>Safe Republican (10-20%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #fb6a4a;"></div>Likely Republican (5.5-10%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #fcae91;"></div>Lean Republican (1-5.5%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #fee8c8;"></div>Tilt Republican (0.5-1%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #f7f7f7; border: 1px solid #999;"></div>Tossup (±0.5%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #e1f5fe;"></div>Tilt Democratic (0.5-1%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #c6dbef;"></div>Lean Democratic (1-5.5%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #9ecae1;"></div>Likely Democratic (5.5-10%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #6baed6;"></div>Safe Democratic (10-20%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #3182bd;"></div>Stronghold Democratic (20-30%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #08519c;"></div>Dominant Democratic (30-40%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #08306b;"></div>Annihilation Democratic (40%+)</div>
      </div>
    </div>
    <script>
      function toggleLegend() {
        const legend = document.getElementById('legend');
        const btn = document.getElementById('legend-minimize-btn');
        if (legend.classList.contains('minimized')) {
          legend.classList.remove('minimized');
          btn.textContent = '−';
        } else {
          legend.classList.add('minimized');
          btn.textContent = '+';
        }
      }
    </script>

    <!-- Status panel -->
    <div class="status-panel" id="status" style="display:none;">
        <strong>Status:</strong> Loading map and data...
    </div>

    <script>
    // --- CONFIG ---
    const CONFIG = {
      mapboxToken: 'pk.eyJ1Ijoic2hhbWFyZGF2aXMiLCJhIjoiY21kcW8yeDB2MDhvbTJzb29qeGp1aDZmZCJ9.Zw_i6U-dL7_bEKRHTUh7yg',
      paths: {
        counties: './Florida_County_Boundaries_with_FDOT_Districts_6074369993038631266.geojson',
        districts: './data/fl_congressional_districts.geojson',
        state_house: './data/fl_state_house_districts.geojson',
        state_senate: './data/fl_state_senate_districts.geojson',
        election: './data/fl_county_election_results.csv',
        congressional: './data/fl_congressional_election_results.csv',
        districts_info: './data/fl_congressional_districts.csv',
        state_house_info: './data/fl_state_house_districts.csv',
        state_senate_info: './data/fl_state_senate_districts.csv'
      },
      center: [-81.5, 28.0],
      zoom: 6.2,
      fitBounds: [[-87.7, 24.5], [-80.0, 31.0]]
    };

    mapboxgl.accessToken = CONFIG.mapboxToken;

    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/light-v11', center: CONFIG.center, zoom: CONFIG.zoom });

    let electionData = null;
    let congressionalData = null;
    let districtsInfo = null;
    let stateHouseInfo = null;
    let stateSenateInfo = null;
    let countyNameMap = {};
    let currentView = 'counties'; // 'counties', 'districts', 'state_house', 'state_senate'
    let currentElectionResults = null; // Current contest results for county details
    // Declare lastSelectedCounty at the top of your script
let lastSelectedCounty = null;

    function setStatus(text) { document.getElementById('status').textContent = text; console.log(text); }

    async function loadJSON(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error(`${path} fetch failed: ${r.status}`);
      return r.json();
    }

    async function loadCSV(path) {
  const r = await fetch(path);
  if (!r.ok) throw new Error(`${path} fetch failed: ${r.status}`);
  return r.text();
    }

    function parseCSV(csvText) {
      try {
        const result = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        });
        if (result.errors.length) {
          setStatus('CSV Parse Error: ' + result.errors.map(e => e.message).join('; '));
          console.error(result.errors);
        }
        return result.data;
      } catch (err) {
        setStatus('CSV Parse Exception: ' + err.message);
        console.error(err);
        return [];
      }
    }
// Merge JSONs (e.g., boundaries + election results)
function mergeGeoElectionData(boundaryGeoJSON, electionData, countyKey='County', countyNameKey='county') {
  // Returns a new GeoJSON with election results merged into feature properties
  if (!boundaryGeoJSON || !boundaryGeoJSON.features || !electionData) return boundaryGeoJSON;
  const electionMap = {};
  function normalizeCountyName(name) {
    if (!name) return '';
    return name
      .replace(/St[\.]?\s*Lucie/i, 'St Lucie')
      .replace(/St[\.]?\s*Johns/i, 'St Johns')
      .replace(/\./g, '')
      .replace(/\s+/g, ' ')
      .trim();
  }
  electionData.forEach(row => {
    let name = normalizeCountyName(row[countyNameKey] || '');
    electionMap[name.toUpperCase()] = row;
  });
  boundaryGeoJSON.features.forEach(f => {
    const p = f.properties || {};
    let name = normalizeCountyName(p[countyKey] || p.COUNTYNAME || p.NAME || p.County || p.name || '');
    const electionRow = electionMap[name.toUpperCase()];
    if (electionRow) {
      Object.assign(f.properties, electionRow);
    }
  });
  return boundaryGeoJSON;
}

    function buildCountyNameMapFromGeoJSON(geojson) {
      const map = {};
      if (!geojson || !geojson.features) return map;
      geojson.features.forEach(f => {
        const p = f.properties || {};
        // Try common FDOT property names: COUNTYNAME, NAME, County
        const name = (p.COUNTYNAME || p.NAME || p.County || p.name || p.NAMELSAD || '').toString().trim();
        if (name) map[name.toUpperCase()] = name;
      });
      return map;
    }

    function formatContestName(contestType, year) {
      const nameMap = {
        'president': 'FL President',
        'governor': 'FL Governor', 
        'us_senate': 'FL US Senate',
        'attorney_general': 'FL Attorney General',
        'cfo': 'FL Chief Financial Officer',
        'agriculture_commissioner': 'FL Agriculture Commissioner',
        'us_house': 'FL US House',
        'state_senate': 'FL State Senate',
        'state_house': 'FL State House',
        'gov': 'FL Governor',
        'pre': 'FL President', 
        'uss': 'FL US Senator',
        'usr': 'FL US Representative',
        'agr': 'FL Agriculture Commissioner',
        'atg': 'FL Attorney General',
        'cfo': 'FL Chief Financial Officer',
        'str': 'FL State Representative',
        'sts': 'FL State Senator',
        'ctj': 'FL Circuit Judge',
        'sta': 'FL State Attorney',
        'pub': 'FL Public Defender',
        'sc1': 'FL Supreme Court Justice',
        'sc2': 'FL Supreme Court Justice',
        'sc3': 'FL Supreme Court Justice',
        'sc4': 'FL Supreme Court Justice',
        'sc5': 'FL Supreme Court Justice'
      };
      
      // Handle amendments
      if (contestType.startsWith('a') && contestType.length <= 3) {
        return `FL Amendment ${contestType.substring(1).toUpperCase()}`;
      }
      
      // Handle judicial retention elections
      if (contestType.startsWith('d')) {
        return `FL Judicial Retention ${contestType.toUpperCase()}`;
      }
      
      return nameMap[contestType] || `FL ${contestType.toUpperCase()}`;
    }

    function populateContestSelectFromElectionJSON(electionData) {
      const sel = document.getElementById('contestSelect');
      sel.innerHTML = '<option value="">Select a contest...</option>';
      
      // Use only non-gerrymandered statewide contests for all views
      populateContestSelectFromCSV(electionData);
    }

    function populateContestSelectFromCSV(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      // Focus on non-gerrymandered statewide contests only (Cabinet offices + federal)
      const contestTypes = ['president', 'governor', 'us_senate', 'attorney_general', 'cfo', 'agriculture_commissioner'];
      
      years.forEach(year => {
        contestTypes.forEach(contestType => {
          // Exclude Governor 2020 from dropdown
          if (contestType === 'governor' && year == 2020) return;
          // Check if this contest type has data for this year
          const hasData = csvData.some(row => {
            // Normalize county names for St Lucie and St Johns
            if (row.county === 'St. Lucie') row.county = 'St Lucie';
            if (row.county === 'St. Johns') row.county = 'St Johns';
            return row.year == year && (row[`${contestType}_total`] > 0);
          });
          if (hasData) {
            const opt = document.createElement('option');
            opt.value = `${contestType}_${year}`;
            opt.textContent = `${formatContestName(contestType, year)} (${year})`;
            sel.appendChild(opt);
          }
        });
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function populateContestSelectForStateHouse(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      
      years.forEach(year => {
        const hasData = csvData.some(row => 
          row.year == year && row.state_house_total > 0
        );
        
        if (hasData) {
          const opt = document.createElement('option');
          opt.value = `state_house_${year}`;
          opt.textContent = `FL State House (${year})`;
          sel.appendChild(opt);
        }
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function populateContestSelectForStateSenate(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      
      years.forEach(year => {
        const hasData = csvData.some(row => 
          row.year == year && row.state_senate_total > 0
        );
        
        if (hasData) {
          const opt = document.createElement('option');
          opt.value = `state_senate_${year}`;
          opt.textContent = `FL State Senate (${year})`;
          sel.appendChild(opt);
        }
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function populateContestSelectFromCongressionalCSV(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      
      years.forEach(year => {
        const hasData = csvData.some(row => 
          row.year == year && row.us_house_total > 0
        );
        
        if (hasData) {
          const opt = document.createElement('option');
          opt.value = `us_house_${year}`;
          opt.textContent = `FL US House (${year})`;
          sel.appendChild(opt);
        }
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function setAnalysisMode(mode) {
      // Update button states
      document.getElementById('county-mode').classList.toggle('active', mode === 'county');
      document.getElementById('district-mode').classList.toggle('active', mode === 'district');
      
      // Could add different analysis modes here (e.g., demographic analysis vs electoral analysis)
      console.log(`Analysis mode set to: ${mode}`);
    }

    function updateStatewideResults(contestType, year, demVotes, repVotes, totalVotes) {
      const statewideContent = document.getElementById('statewide-content');
      
      if (totalVotes === 0) {
        statewideContent.innerHTML = '<p>No statewide data available for this contest.</p>';
        return;
      }
      
      const demPct = (demVotes / totalVotes) * 100;
      const repPct = (repVotes / totalVotes) * 100;
      const marginPct = Math.abs(demPct - repPct);
      const winner = demPct > repPct ? 'Democratic' : 'Republican';
      const loser = demPct > repPct ? 'Republican' : 'Democratic';
      
      // Get candidate names based on contest type and year
      let demCandidate = 'Democratic';
      let repCandidate = 'Republican';
      
      if (contestType === 'president') {
        if (year == 2024) { demCandidate = 'Harris'; repCandidate = 'Trump'; }
        else if (year == 2020) { demCandidate = 'Biden'; repCandidate = 'Trump'; }
        else if (year == 2016) { demCandidate = 'Clinton'; repCandidate = 'Trump'; }
        else if (year == 2012) { demCandidate = 'Obama'; repCandidate = 'Romney'; }
        else if (year == 2008) { demCandidate = 'Obama'; repCandidate = 'McCain'; }
      }
      
      statewideContent.innerHTML = `
        <div class="statewide-margin">
          <div class="margin-text" style="color: ${winner === 'Republican' ? '#dc2626' : '#1e40af'};">
            ${winner === 'Republican' ? repCandidate : demCandidate} +${marginPct.toFixed(2)}%
          </div>
          <div class="margin-details">
            ${demCandidate}: ${demPct.toFixed(1)}% (${demVotes.toLocaleString()})<br>
            ${repCandidate}: ${repPct.toFixed(1)}% (${repVotes.toLocaleString()})<br>
            Total Votes: ${totalVotes.toLocaleString()}
          </div>
        </div>
      `;
    }

function setMapView(view) {
  currentView = view;
  
  // Update button states
  document.getElementById('counties-view').classList.toggle('active', view === 'counties');
  document.getElementById('districts-view').classList.toggle('active', view === 'districts');
  document.getElementById('state-house-view').classList.toggle('active', view === 'state_house');
  document.getElementById('state-senate-view').classList.toggle('active', view === 'state_senate');
  
  // Update 2000 VTDs button if available
  const vtds2000Button = document.getElementById('vtds-2000-view');
  if (vtds2000Button) {
    vtds2000Button.classList.toggle('active', view === 'vtds_2000');
  }
  // You may want to add logic here to show/hide layers depending on view
  // For example:
  // if (view === 'counties') addCountyLayers();
  // else if (view === 'districts') addDistrictLayers();
  // else if (view === 'state_house') addStateHouseLayers();
  // else if (view === 'state_senate') addStateSenateLayers();
}


// Share button (NC map style)
var shareContainer = document.getElementById('share-container');
if (shareContainer) {
  shareContainer.innerHTML = '<button id="share-btn" style="padding:8px 16px;border-radius:8px;background:#2563eb;color:#fff;border:none;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.12);cursor:pointer;">Share Map</button>';
  var shareBtn = document.getElementById('share-btn');
  if (shareBtn) {
    shareBtn.onclick = function() {
      navigator.clipboard.writeText(window.location.href);
      alert('Map link copied to clipboard!');
    };
  }
}

    function toggleMainControls() {
      const controls = document.getElementById('main-controls');
      const controlsContent = document.getElementById('controls-content');
      const minimizeBtn = document.getElementById('controls-minimize-btn');
      
      if (controls.classList.contains('minimized')) {
        // Expand controls
        controls.classList.remove('minimized');
        controlsContent.style.display = 'block';
        minimizeBtn.textContent = '−';
        minimizeBtn.title = 'Minimize controls';
      } else {
        // Minimize controls
        controls.classList.add('minimized');
        controlsContent.style.display = 'none';
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Expand controls';
      }
    }

    // Floating expand button logic (modern NC map style)
function updateFloatBtnVisibility() {
  const sidebar = document.getElementById('sidebar');
  const floatBtn = document.getElementById('sidebar-float-toggle');
  if (sidebar.classList.contains('minimized')) {
    floatBtn.style.display = 'flex';
  } else {
    floatBtn.style.display = 'none';
  }
}
document.addEventListener('DOMContentLoaded', function() {
  var floatBtn = document.getElementById('sidebar-float-toggle');
  if (floatBtn) {
    floatBtn.innerHTML = '+';
    floatBtn.onclick = function() {
      toggleSidebar();
    };
  }
});
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebar-minimize-btn');
  const floatBtn = document.getElementById('sidebar-float-toggle');
  if (sidebar.classList.contains('minimized')) {
    sidebar.classList.remove('minimized');
    btn.textContent = '−';
    if (floatBtn) {
      floatBtn.style.display = 'none';
      floatBtn.innerHTML = '−';
    }
  } else {
    sidebar.classList.add('minimized');
    btn.textContent = '+';
    if (floatBtn) {
      floatBtn.style.display = 'flex';
      floatBtn.innerHTML = '+';
    }
  }
  setTimeout(() => {
    if (window.map && typeof window.map.resize === 'function') {
      window.map.resize();
    }
  }, 350);
}

// Make sure there is only one definition of showCountyDetails in your script.

function showDistrictDetails(districtNum) {
    const detailsDiv = document.getElementById('county-details');
    const nameEl = document.getElementById('county-name');
    const contentEl = document.getElementById('county-info-content');

  nameEl.textContent = `Congressional District ${districtNum}`;

  // Get district info from districtsInfo CSV
  const districtInfo = districtsInfo?.find(d => String(d.district) == String(districtNum));

  let demographicInfo = '';
  if (districtInfo) {
    demographicInfo = `
      <div style="margin-bottom: 16px;">
        <h5>👥 Demographics (VAP)</h5>
        <p><strong>Total Population:</strong> ${Number(districtInfo.total_population).toLocaleString()}</p>
        <p><strong>White:</strong> ${districtInfo.white_vap_pct}%</p>
        <p><strong>Black:</strong> ${districtInfo.black_vap_pct}%</p>
        <p><strong>Hispanic:</strong> ${districtInfo.hispanic_vap_pct}%</p>
      </div>
    `;
  }

  // Get current contest results if available
  const contestValue = document.getElementById('contestSelect').value;
  let electionInfo = '';

  if (contestValue && congressionalData) {
    const lastUnderscoreIndex = contestValue.lastIndexOf('_');
    const contestType = contestValue.substring(0, lastUnderscoreIndex);
    const year = contestValue.substring(lastUnderscoreIndex + 1);

    if (contestType === 'us_house') {
      const result = congressionalData.find(row =>
        String(row.year) == String(year) && String(row.district) == String(districtNum)
      );

      if (result && result.us_house_total > 0) {
        const demVotes = Number(result.us_house_dem) || 0;
        const repVotes = Number(result.us_house_rep) || 0;
        const totalVotes = Number(result.us_house_total) || 0;

        const demPct = totalVotes > 0 ? (demVotes / totalVotes) * 100 : 0;
        const repPct = totalVotes > 0 ? (repVotes / totalVotes) * 100 : 0;
        const marginPct = Math.abs(demPct - repPct);
        const winner = demPct > repPct ? 'Democratic' : 'Republican';

        // Determine competitiveness
        let competitiveness;
        if (marginPct >= 40) {
          competitiveness = winner === 'Republican' ? 'Annihilation Republican' : 'Annihilation Democratic';
        } else if (marginPct >= 30) {
          competitiveness = winner === 'Republican' ? 'Dominant Republican' : 'Dominant Democratic';
        } else if (marginPct >= 20) {
          competitiveness = winner === 'Republican' ? 'Stronghold Republican' : 'Stronghold Democratic';
        } else if (marginPct >= 10) {
          competitiveness = winner === 'Republican' ? 'Safe Republican' : 'Safe Democratic';
        } else if (marginPct >= 5.5) {
          competitiveness = winner === 'Republican' ? 'Likely Republican' : 'Likely Democratic';
        } else if (marginPct >= 1) {
          competitiveness = winner === 'Republican' ? 'Lean Republican' : 'Lean Democratic';
        } else if (marginPct >= 0.5) {
          competitiveness = winner === 'Republican' ? 'Tilt Republican' : 'Tilt Democratic';
        } else {
          competitiveness = `Tossup (${winner} win)`;
        }
        let compColor = '#6b7280';
        if (competitiveness.includes('Rep')) {
          if (competitiveness.includes('Annihilation')) compColor = '#67000d';
          else if (competitiveness.includes('Dominant')) compColor = '#a50f15';
          else if (competitiveness.includes('Stronghold')) compColor = '#cb181d';
          else if (competitiveness.includes('Safe')) compColor = '#ef3b2c';
          else if (competitiveness.includes('Likely')) compColor = '#fb6a4a';
          else if (competitiveness.includes('Lean')) compColor = '#fcae91';
          else if (competitiveness.includes('Tilt')) compColor = '#fee8c8';
        } else if (competitiveness.includes('Dem')) {
          if (competitiveness.includes('Annihilation')) compColor = '#08306b';
          else if (competitiveness.includes('Dominant')) compColor = '#08519c';
          else if (competitiveness.includes('Stronghold')) compColor = '#3182bd';
          else if (competitiveness.includes('Safe')) compColor = '#6baed6';
          else if (competitiveness.includes('Likely')) compColor = '#9ecae1';
          else if (competitiveness.includes('Lean')) compColor = '#c6dbef';
          else if (competitiveness.includes('Tilt')) compColor = '#e1f5fe';
        }

        electionInfo = `
          <div style="margin-bottom: 16px;">
            <h5>🎯 Competitiveness</h5>
            <p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>
          </div>
          <div style="margin-bottom: 16px;">
            <h5>📈 Margin</h5>
            <p style="color: ${winner === 'Republican' ? '#dc2626' : '#1e40af'}; font-weight: bold; font-size: 18px;">
              ${winner} +${marginPct.toFixed(1)}%
            </p>
          </div>
          <div style="margin-bottom: 16px;">
            <h5>🗳️ Vote Breakdown</h5>
            <p><span style="color: #1e40af; font-weight: bold;">Democratic: </span>${demPct.toFixed(1)}% (${demVotes.toLocaleString()})</p>
            <p><span style="color: #dc2626; font-weight: bold;">Republican: </span>${repPct.toFixed(1)}% (${repVotes.toLocaleString()})</p>
            <p><strong>Total Votes:</strong> ${totalVotes.toLocaleString()}</p>
          </div>
        `;
      }
    }
  }
  contentEl.innerHTML = demographicInfo + electionInfo;
  detailsDiv.style.display = 'block';
}

// Ensure sidebar minimize/expand logic matches NC map
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebar-minimize-btn');
  const floatBtn = document.getElementById('sidebar-float-toggle');
  if (sidebar.classList.contains('minimized')) {
    sidebar.classList.remove('minimized');
    btn.textContent = '−';
    if (floatBtn) floatBtn.style.display = 'none';
  } else {
    sidebar.classList.add('minimized');
    btn.textContent = '+';
    if (floatBtn) {
      floatBtn.style.display = 'flex';
      floatBtn.innerHTML = '+';
    }
  }
  setTimeout(() => {
    if (window.map && typeof window.map.resize === 'function') {
      window.map.resize();
    }
  }, 350);
}

// Quick info functions for hover tooltips
function getQuickCountyInfo(countyName) {
      // Find the most recent presidential election data
      const recent = electionData
        .filter(row => row.county === countyName && row.president_total > 0)
        .sort((a, b) => b.year - a.year)[0];
      
      if (recent) {
        const demPct = (recent.president_dem / recent.president_total) * 100;
        const repPct = (recent.president_rep / recent.president_total) * 100;
        const margin = demPct - repPct;
        const winner = margin > 0 ? 'D' : 'R';
        const marginAbs = Math.abs(margin);
        
        return `<div class="quick-tooltip">
          <strong>${countyName} County</strong><br>
          ${recent.year}: ${winner}+${marginAbs.toFixed(1)}%<br>
          <em>Click for full trends</em>
        </div>`;
      }
      
      return `<div class="quick-tooltip">
        <strong>${countyName} County</strong><br>
        <em>Click for details</em>
      </div>`;
    }

    function getQuickDistrictInfo(districtNum, type) {
      let displayName = '';
      let recent = null;
      
      if (type === 'congressional') {
        displayName = `Congressional District ${districtNum}`;
        recent = congressionalData
          .filter(row => row.district == districtNum && row.us_house_total > 0)
          .sort((a, b) => b.year - a.year)[0];
          
        if (recent) {
          const demPct = (recent.us_house_dem / recent.us_house_total) * 100;
          const repPct = (recent.us_house_rep / recent.us_house_total) * 100;
          const margin = demPct - repPct;
          const winner = margin > 0 ? 'D' : 'R';
          const marginAbs = Math.abs(margin);
          
          return `<div class="quick-tooltip">
            <strong>${displayName}</strong><br>
            ${recent.year}: ${winner}+${marginAbs.toFixed(1)}%<br>
            <em>Click for full trends</em>
          </div>`;
        }
      } else if (type === 'house') {
        displayName = `State House District ${districtNum}`;
      } else if (type === 'senate') {
        displayName = `State Senate District ${districtNum}`;
      }
      
      return `<div class="quick-tooltip">
        <strong>${displayName}</strong><br>
        <em>Click for details</em>
      </div>`;
    }

    async function init() {
      try {
        setStatus('Loading counties...');
        console.log('Loading counties from:', CONFIG.paths.counties);
        const counties = await loadJSON(CONFIG.paths.counties);
        console.log('Counties loaded successfully:', counties.features?.length, 'features');
        // Add counties source only if not present
        if (!map.getSource('counties')) {
          map.addSource('counties', { type: 'geojson', data: counties });
        }
        countyNameMap = buildCountyNameMapFromGeoJSON(counties);
        console.log('County name map built:', Object.keys(countyNameMap).length, 'counties');
        
        // Add initial county layers
        addCountyLayers();

        setStatus('Counties loaded');

        setStatus('Loading election data...');
        console.log('Loading election data from:', CONFIG.paths.election);
        const electionCSV = await loadCSV(CONFIG.paths.election);
        electionData = parseCSV(electionCSV);
        setStatus('Election data loaded');

        setStatus('Loading congressional data...');
        const congressionalCSV = await loadCSV(CONFIG.paths.congressional);
        congressionalData = parseCSV(congressionalCSV);
        
        const districtsCSV = await loadCSV(CONFIG.paths.districts_info);
        districtsInfo = parseCSV(districtsCSV);
        setStatus('Congressional data loaded');

        // Load congressional districts GeoJSON
        setStatus('Loading congressional districts...');
        const districtsGeoJSON = await loadJSON(CONFIG.paths.districts);
        map.addSource('districts', { type: 'geojson', data: districtsGeoJSON });
        setStatus('Congressional districts loaded');

        // Load state legislative districts
        setStatus('Loading state house districts...');
        const stateHouseGeoJSON = await loadJSON(CONFIG.paths.state_house);
        map.addSource('state-house', { type: 'geojson', data: stateHouseGeoJSON });
        
        const stateHouseCSV = await loadCSV(CONFIG.paths.state_house_info);
        stateHouseInfo = parseCSV(stateHouseCSV);
        setStatus('State house districts loaded');

        setStatus('Loading state senate districts...');
        const stateSenateGeoJSON = await loadJSON(CONFIG.paths.state_senate);
        map.addSource('state-senate', { type: 'geojson', data: stateSenateGeoJSON });
        
        const stateSenateCSV = await loadCSV(CONFIG.paths.state_senate_info);
        stateSenateInfo = parseCSV(stateSenateCSV);
        setStatus('State senate districts loaded');

        populateContestSelectFromElectionJSON(electionData);

        map.fitBounds(CONFIG.fitBounds, { padding: 20 });

      } catch (e) {
        setStatus('Error: ' + e.message);
      }
    }

    function getCountyAggregates(results) {
      const agg = {};
      Object.values(results || {}).forEach(r => {
        const countyKey = (r.county || '').toString().trim();
        if (!countyKey) return;
        if (!agg[countyKey]) agg[countyKey] = { dem:0, rep:0, total:0 };
        agg[countyKey].dem += (r.dem_votes||0);
        agg[countyKey].rep += (r.rep_votes||0);
        agg[countyKey].total += (r.total_votes||0);
      });
      return agg;
    }

    function categoryColorForMargin(marginPct, winner) {
      // NC map criteria: exact same thresholds and colors
      if (marginPct >= 40) {
        return winner === 'R' ? '#67000d' : '#08306b'; // Annihilation
      } else if (marginPct >= 30) {
        return winner === 'R' ? '#a50f15' : '#08519c'; // Dominant
      } else if (marginPct >= 20) {
        return winner === 'R' ? '#cb181d' : '#3182bd'; // Stronghold
      } else if (marginPct >= 10) {
        return winner === 'R' ? '#ef3b2c' : '#6baed6'; // Safe
      } else if (marginPct >= 5.5) {
        return winner === 'R' ? '#fb6a4a' : '#9ecae1'; // Likely
      } else if (marginPct >= 1) {
        return winner === 'R' ? '#fcae91' : '#c6dbef'; // Lean
      } else if (marginPct >= 0.5) {
        return winner === 'R' ? '#fee8c8' : '#e1f5fe'; // Tilt
      } else {
        return '#f7f7f7'; // Tossup
      }
    }

    function applyContest(contestKey) {
      if (!contestKey) return setStatus('Select a contest');
      
      // Split contest key properly - year is always the last part after final underscore
      const lastUnderscoreIndex = contestKey.lastIndexOf('_');
      const contestType = contestKey.substring(0, lastUnderscoreIndex);
      const year = contestKey.substring(lastUnderscoreIndex + 1);
      
      if (currentView === 'counties') {
        applyCountyContest(contestType, year);
      } else if (currentView === 'districts' && contestType === 'us_house') {
        // US House races use district-specific data
        applyDistrictContest(contestType, year);
      } else {
        // All other contests (statewide) aggregate county data by district
        applyStatewideContestToDistricts(contestType, year);
      }
    }

    function applyCountyContest(contestType, year) {
      // Filter data for this contest and year
      const contestData = electionData.filter(row => row.year == year);
      
      console.log(`Applying ${contestType} for ${year}:`, contestData.length, 'counties found');
      
      if (contestData.length === 0) {
        return setStatus('No data found for this contest');
      }

      // Store current results for county details
      currentElectionResults = {};
      contestData.forEach(row => {
        currentElectionResults[row.county] = row;
      });

      // Calculate statewide totals
      let statewidedemVotes = 0;
      let statewidrepVotes = 0;
      let statewidTotalVotes = 0;
      
      contestData.forEach(row => {
        const demVotes = row[`${contestType}_dem`] || 0;
        const repVotes = row[`${contestType}_rep`] || 0;
        statewidedemVotes += demVotes;
        statewidrepVotes += repVotes;
        statewidTotalVotes += demVotes + repVotes;
      });
      
      // Update statewide results display
      updateStatewideResults(contestType, year, statewidedemVotes, statewidrepVotes, statewidTotalVotes);

      // Build expression for county coloring
      const expr = ['case'];
      let countiesProcessed = 0;
      
      contestData.forEach(row => {
        const countyName = row.county;
        const demVotes = row[`${contestType}_dem`] || 0;
        const repVotes = row[`${contestType}_rep`] || 0;
        const totalVotes = row[`${contestType}_total`] || 0;
        
        if (totalVotes === 0) return;
        
        const demPct = (demVotes / totalVotes) * 100;
        const repPct = (repVotes / totalVotes) * 100;
        const winner = repPct > demPct ? 'R' : 'D';
        const marginPct = Math.abs(repPct - demPct);
        const color = categoryColorForMargin(marginPct, winner);
        
        expr.push(['==', ['get', 'County'], countyName]);
        expr.push(color);
        countiesProcessed++;
      });
      
      expr.push('#e0e0e0'); // default color
      
      console.log(`Color expression built for ${countiesProcessed} counties`);
      
      map.setPaintProperty('county-fill', 'fill-color', expr);
      document.getElementById('statewide').textContent = `FL ${formatContestName(contestType, year)} (${year})`;
      setStatus(`Applied contest: ${formatContestName(contestType, year)} ${year}`);
    }

    function applyDistrictContest(contestType, year) {
      if (contestType !== 'us_house') {
        return setStatus('Only US House races available for congressional districts');
      }
      
      // Filter congressional data for this year
      const contestData = congressionalData.filter(row => row.year == year);
      
      if (contestData.length === 0) {
        return setStatus('No congressional data found for this year');
      }

      // Build expression for district coloring
      const expr = ['case'];
      
      contestData.forEach(row => {
        const district = row.district;
        const demVotes = row.us_house_dem || 0;
        const repVotes = row.us_house_rep || 0;
        const totalVotes = row.us_house_total || 0;
        
        if (totalVotes === 0) return;
        
        const demPct = (demVotes / totalVotes) * 100;
        const repPct = (repVotes / totalVotes) * 100;
        const winner = repPct > demPct ? 'R' : 'D';
        const marginPct = Math.abs(repPct - demPct);
        const color = categoryColorForMargin(marginPct, winner);
        
        expr.push(['==', ['get', 'DISTRICT'], district]);
        expr.push(color);
      });
      
      expr.push('#e0e0e0'); // default color
      
      map.setPaintProperty('district-fill', 'fill-color', expr);
      document.getElementById('statewide').textContent = `FL US House (${year})`;
      setStatus(`Applied contest: FL US House ${year}`);
    }

    function applyStatewideContestToDistricts(contestType, year) {
      // For statewide contests in district views, we need to aggregate county data by district
      const contestData = electionData.filter(row => row.year == year);
      
      if (contestData.length === 0) {
        return setStatus('No data found for this contest');
      }

      // We need county-to-district mapping - this is a simplified approach
      // In a full implementation, you'd need actual county-to-district mapping data
      // For now, we'll apply the statewide contest to districts using a placeholder approach
      // Each district will show the statewide result (this could be enhanced with actual mapping)
      
      // Calculate statewide totals for this contest
      let totalDem = 0;
      let totalRep = 0;
      let totalVotes = 0;
      
      contestData.forEach(row => {
        const demVotes = parseInt(row[`${contestType}_dem`]) || 0;
        const repVotes = parseInt(row[`${contestType}_rep`]) || 0;
        totalDem += demVotes;
        totalRep += repVotes;
        totalVotes += demVotes + repVotes;
      });
      
      if (totalVotes === 0) {
        return setStatus(`No data found for ${contestType} in ${year}`);
      }
      
      const demPct = (totalDem / totalVotes) * 100;
      const repPct = (totalRep / totalVotes) * 100;
      const winner = repPct > demPct ? 'R' : 'D';
      const marginPct = Math.abs(repPct - demPct);
      const color = categoryColorForMargin(marginPct, winner);
      
      // Apply uniform color to all districts (showing statewide result)
      // This is a simplified approach - ideally you'd aggregate by actual district boundaries
      const layerName = currentView === 'districts' ? 'district-fill' : 
                       currentView === 'state_house' ? 'state-house-fill' : 'state-senate-fill';
      
      map.setPaintProperty(layerName, 'fill-color', color);
      
      document.getElementById('statewide').textContent = `FL ${formatContestName(contestType, year)} (${year}) - Statewide Result`;
      setStatus(`Applied statewide contest: ${formatContestName(contestType, year)} ${year} (${demPct.toFixed(1)}% D, ${repPct.toFixed(1)}% R)`);
    }

    // County swing arrows logic
function drawCountySwingLayer(swingData) {
  const canvas = document.getElementById('countySwingLayer');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  swingData.forEach(({ x, y, swing }) => {
    // Arrow color: blue for Dem swing, red for GOP swing
    ctx.strokeStyle = swing > 0 ? '#2563eb' : '#cb181d';
    ctx.lineWidth = Math.min(10, Math.abs(swing));
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + swing * 10, y); // Arrow length by swing value
    ctx.stroke();
    // Draw arrowhead
    ctx.beginPath();
    ctx.moveTo(x + swing * 10, y);
    ctx.lineTo(x + swing * 10 - 5, y - 5);
    ctx.lineTo(x + swing * 10 - 5, y + 5);
    ctx.closePath();
    ctx.fillStyle = ctx.strokeStyle;
    ctx.fill();
  });
}
function addCountyLayers() {
  if (!map.getLayer('county-fill')) {
    map.addLayer({
      id: 'county-fill',
      type: 'fill',
      source: 'counties',
      paint: {
        'fill-color': '#e0e0e0',
        'fill-opacity': 0.7
      }
    });
    map.addLayer({
      id: 'county-outline',
      type: 'line',
      source: 'counties',
      paint: {
        'line-color': '#374151',
        'line-width': 1
      }
    });
  }
}

function addDistrictLayers() {
  if (!map.getLayer('district-fill')) {
    map.addLayer({
      id: 'district-fill',
      type: 'fill',
      source: 'districts',
      paint: {
        'fill-color': '#e0e0e0',
        'fill-opacity': 0.7
      }
    });
    map.addLayer({
      id: 'district-outline',
      type: 'line',
      source: 'districts',
      paint: {
        'line-color': '#374151',
        'line-width': 1
      }
    });
  }
}

function addStateHouseLayers() {
  if (!map.getLayer('state-house-fill')) {
    map.addLayer({
      id: 'state-house-fill',
      type: 'fill',
      source: 'state-house',
      paint: {
        'fill-color': '#e0e0e0',
        'fill-opacity': 0.7
      }
    });
    map.addLayer({
      id: 'state-house-outline',
      type: 'line',
      source: 'state-house',
      paint: {
        'line-color': '#374151',
        'line-width': 1
      }
    });
  }
}

function addStateSenateLayers() {
  if (!map.getLayer('state-senate-fill')) {
    map.addLayer({
      id: 'state-senate-fill',
      type: 'fill',
      source: 'state-senate',
      paint: {
        'fill-color': '#e0e0e0',
        'fill-opacity': 0.7
      }
    });
    map.addLayer({
      id: 'state-senate-outline',
      type: 'line',
      source: 'state-senate',
      paint: {
        'line-color': '#374151',
        'line-width': 1
      }
    });
  }
}

// --- INTERACTION HANDLERS ---
// Add click and hover handlers for counties and districts
map.on('click', 'county-fill', function(e) {
  if (!e.features || !e.features.length) return;
  const countyName = e.features[0].properties.County || e.features[0].properties.COUNTYNAME || e.features[0].properties.NAME || '';
  lastSelectedCounty = countyName;
  showCountyDetails(countyName);
  document.getElementById('sidebar').classList.remove('minimized');
  document.getElementById('sidebar-minimize-btn').textContent = '−';
  updateFloatBtnVisibility();
});

map.on('mousemove', 'county-fill', function(e) {
  if (!e.features || !e.features.length) {
    document.getElementById('hover-tooltip').style.display = 'none';
    return;
  }
  const countyName = e.features[0].properties.County || e.features[0].properties.COUNTYNAME || e.features[0].properties.NAME || '';
  const tooltip = document.getElementById('hover-tooltip');
  tooltip.innerHTML = getQuickCountyInfo(countyName);
  tooltip.style.display = 'block';
  tooltip.style.left = (e.point.x + 15) + 'px';
  tooltip.style.top = (e.point.y + 15) + 'px';
});

map.on('mouseleave', 'county-fill', function() {
  document.getElementById('hover-tooltip').style.display = 'none';
});

// District click/hover handlers
map.on('click', 'district-fill', function(e) {
  if (!e.features || !e.features.length) return;
  const districtNum = e.features[0].properties.DISTRICT;
  showDistrictDetails(districtNum);
  document.getElementById('sidebar').classList.remove('minimized');
  document.getElementById('sidebar-minimize-btn').textContent = '−';
  updateFloatBtnVisibility();
});

map.on('mousemove', 'district-fill', function(e) {
  if (!e.features || !e.features.length) {
    document.getElementById('hover-tooltip').style.display = 'none';
    return;
  }
  const districtNum = e.features[0].properties.DISTRICT;
  const tooltip = document.getElementById('hover-tooltip');
  tooltip.innerHTML = getQuickDistrictInfo(districtNum, 'congressional');
  tooltip.style.display = 'block';
  tooltip.style.left = (e.point.x + 15) + 'px';
  tooltip.style.top = (e.point.y + 15) + 'px';
});

map.on('mouseleave', 'district-fill', function() {

  document.getElementById('hover-tooltip').style.display = 'none';
});

// Only keep one definition of showCountyDetails to avoid errors.
function showCountyDetails(countyName) {
  const detailsDiv = document.getElementById('county-details');
  const nameEl = document.getElementById('county-name');
  const contentEl = document.getElementById('county-info-content');
  let demographicInfo = '';
  nameEl.textContent = `${countyName} County`;

  if (!currentElectionResults) {
    contentEl.innerHTML = '<p>Select a contest to see county results.</p>';
    detailsDiv.style.display = 'block';
    return;
  }

  // Find county results for current contest
  const countyData = currentElectionResults[countyName];

  if (!countyData) {
    contentEl.innerHTML = '<p>No results found for this county in the selected contest.</p>';
    detailsDiv.style.display = 'block';
    return;
  }

  // Get the current contest type and year from the dropdown
  const contestValue = document.getElementById('contestSelect').value;
  let electionInfo = '';

  // Fix: define districtNum if needed (for US House contest)
  let districtNum = countyData.district || countyData.DISTRICT || null;

  if (contestValue && congressionalData) {
    const lastUnderscoreIndex = contestValue.lastIndexOf('_');
    const contestType = contestValue.substring(0, lastUnderscoreIndex);
    const year = contestValue.substring(lastUnderscoreIndex + 1);

    if (contestType === 'us_house' && districtNum) {
      const result = congressionalData.find(row =>
        String(row.year) === String(year) && String(row.district) === String(districtNum)
      );

      if (result && result.us_house_total > 0) {
        const demVotes = Number(result.us_house_dem) || 0;
        const repVotes = Number(result.us_house_rep) || 0;
        const totalVotes = Number(result.us_house_total) || 0;

        const demPct = totalVotes > 0 ? (demVotes / totalVotes) * 100 :   0;
        const repPct = totalVotes > 0 ? (repVotes / totalVotes) * 100 : 0;
        const marginPct = Math.abs(demPct - repPct);
        const winner = demPct > repPct ? 'Democratic' : 'Republican';

        // Determine competitiveness
        let competitiveness;
        if (marginPct >= 40) {
          competitiveness = winner === 'Republican' ? 'Annihilation Republican' : 'Annihilation Democratic';
        } else if (marginPct >= 30) {
          competitiveness = winner === 'Republican' ? 'Dominant Republican' : 'Dominant Democratic';
        } else if (marginPct >= 20) {
          competitiveness = winner === 'Republican' ? 'Stronghold Republican' : 'Stronghold Democratic';
        } else if (marginPct >= 10) {
          competitiveness = winner === 'Republican' ? 'Safe Republican' : 'Safe Democratic';
        } else if (marginPct >= 5.5) {
          competitiveness = winner === 'Republican' ? 'Likely Republican' : 'Likely Democratic';
        } else if (marginPct >= 1) {
          competitiveness = winner === 'Republican' ? 'Lean Republican' : 'Lean Democratic';
        } else if (marginPct >= 0.5) {
          competitiveness = winner === 'Republican' ? 'Tilt Republican' : 'Tilt Democratic';
        } else {
          competitiveness = `Tossup (${winner} win)`;
        }
        let compColor = '#6b7280';
        if (competitiveness.includes('Rep')) {
          if (competitiveness.includes('Annihilation')) compColor = '#67000d';
          else if (competitiveness.includes('Dominant')) compColor = '#a50f15';
          else if (competitiveness.includes('Stronghold')) compColor = '#cb181d';
          else if (competitiveness.includes('Safe')) compColor = '#ef3b2c';
          else if (competitiveness.includes('Likely')) compColor = '#fb6a4a';
          else if (competitiveness.includes('Lean')) compColor = '#fcae91';
          else if (competitiveness.includes('Tilt')) compColor = '#fee8c8';
        } else if (competitiveness.includes('Dem')) {
          if (competitiveness.includes('Annihilation')) compColor = '#08306b';
          else if (competitiveness.includes('Dominant')) compColor = '#08519c';
          else if (competitiveness.includes('Stronghold')) compColor = '#3182bd';
          else if (competitiveness.includes('Safe')) compColor = '#6baed6';
          else if (competitiveness.includes('Likely')) compColor = '#9ecae1';
          else if (competitiveness.includes('Lean')) compColor = '#c6dbef';
          else if (competitiveness.includes('Tilt')) compColor = '#e1f5fe';
        }

        electionInfo = `
          <div style="margin-bottom: 16px;">
            <h5>🎯 Competitiveness</h5>
            <p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>
          </div>
          <div style="margin-bottom: 16px;">
            <h5>📈 Margin</h5>
            <p style="color: ${winner === 'Republican' ? '#dc2626' : '#1e40af'}; font-weight: bold; font-size: 18px;">
              ${winner} +${marginPct.toFixed(1)}%
            </p>
          </div>
          <div style="margin-bottom: 16px;">
            <h5>🗳️ Vote Breakdown</h5>
            <p><span style="color: #1e40af; font-weight: bold;">Democratic: </span>${demPct.toFixed(1)}% (${demVotes.toLocaleString()})</p>
            <p><span style="color: #dc2626; font-weight: bold;">Republican: </span>${repPct.toFixed(1)}% (${repVotes.toLocaleString()})</p>
            <p><strong>Total Votes:</strong> ${totalVotes.toLocaleString()}</p>
          </div>
        `;
      }
    }
  }
  contentEl.innerHTML = demographicInfo + electionInfo;
  detailsDiv.style.display = 'block';
}

// --- County Analysis Sidebar: NC-style calculations and layout ---
function showCountyDetails(countyName) {
  const sidebar = document.getElementById('sidebar');
  if (sidebar) {
    sidebar.classList.remove('minimized');
    const floatBtn = document.getElementById('sidebar-float-toggle');
    if (floatBtn) floatBtn.style.display = 'none';
    const btn = document.getElementById('sidebar-minimize-btn');
    if (btn) btn.textContent = '−';
  }
  const detailsDiv = document.getElementById('county-details');
  const nameEl = document.getElementById('county-name');
  const contentEl = document.getElementById('county-info-content');
  if (!detailsDiv || !nameEl || !contentEl) return;
  nameEl.textContent = `${countyName} County`;
  let sidebarContent = '';
  if (currentElectionResults && currentElectionResults[countyName]) {
    const data = currentElectionResults[countyName];
    // NC-style calculations
    const demVotes = data.dem_votes || data.president_dem || 0;
    const repVotes = data.rep_votes || data.president_rep || 0;
    const totalVotes = data.total_votes || data.president_total || (demVotes + repVotes);
    const demPct = totalVotes > 0 ? (demVotes / totalVotes) * 100 : 0;
    const repPct = totalVotes > 0 ? (repVotes / totalVotes) * 100 : 0;
    const marginPct = Math.abs(demPct - repPct);
    const winner = demPct > repPct ? 'Democratic' : 'Republican';
    // Competitiveness (NC logic)
    let competitiveness;
    if (marginPct >= 40) {
      competitiveness = winner === 'Republican' ? 'Annihilation Republican' : 'Annihilation Democratic';
    } else if (marginPct >= 30) {
      competitiveness = winner === 'Republican' ? 'Dominant Republican' : 'Dominant Democratic';
    } else if (marginPct >= 20) {
      competitiveness = winner === 'Republican' ? 'Stronghold Republican' : 'Stronghold Democratic';
    } else if (marginPct >= 10) {
      competitiveness = winner === 'Republican' ? 'Safe Republican' : 'Safe Democratic';
    } else if (marginPct >= 5.5) {
      competitiveness = winner === 'Republican' ? 'Likely Republican' : 'Likely Democratic';
    } else if (marginPct >= 1) {
      competitiveness = winner === 'Republican' ? 'Lean Republican' : 'Lean Democratic';
    } else if (marginPct >= 0.5) {
      competitiveness = winner === 'Republican' ? 'Tilt Republican' : 'Tilt Democratic';
    } else {
      competitiveness = `Tossup (${winner} win)`;
    }
    // --- NC map sidebar layout ---
    let winnerColor = winner === 'Republican' ? '#dc2626' : '#2563eb';
    let compColor = '#6b7280';
    if (competitiveness.includes('Rep')) {
      if (competitiveness.includes('Annihilation')) compColor = '#67000d';
      else if (competitiveness.includes('Dominant')) compColor = '#a50f15';
      else if (competitiveness.includes('Stronghold')) compColor = '#cb181d';
      else if (competitiveness.includes('Safe')) compColor = '#ef3b2c';
      else if (competitiveness.includes('Likely')) compColor = '#fb6a4a';
      else if (competitiveness.includes('Lean')) compColor = '#fcae91';
      else if (competitiveness.includes('Tilt')) compColor = '#fee8c8';
    } else if (competitiveness.includes('Dem')) {
      if (competitiveness.includes('Annihilation')) compColor = '#08306b';
      else if (competitiveness.includes('Dominant')) compColor = '#08519c';
      else if (competitiveness.includes('Stronghold')) compColor = '#3182bd';
      else if (competitiveness.includes('Safe')) compColor = '#6baed6';
      else if (competitiveness.includes('Likely')) compColor = '#9ecae1';
      else if (competitiveness.includes('Lean')) compColor = '#c6dbef';
      else if (competitiveness.includes('Tilt')) compColor = '#e1f5fe';
    }
    sidebarContent = `
      <div class="result-summary">
        <h5>📊 Election Results</h5>
        <p><strong>Total Votes:</strong> ${totalVotes.toLocaleString()}</p>
      </div>
      <div class="winner-section">
        <h5>🏆 Winner</h5>
        <p style="color: ${winnerColor}; font-weight: bold; font-size: 16px;">${winner}</p>
      </div>
      <div class="margin-section">
        <h5>📈 Margin</h5>
        <p style="color: ${winnerColor}; font-weight: bold; font-size: 18px;">${winner} +${marginPct.toFixed(1)}%</p>
        <p style="color: #6b7280; font-size: 14px;">(${Math.abs(demVotes-repVotes).toLocaleString()} vote margin)</p>
      </div>
      <div class="vote-breakdown">
        <h5>🗳️ Vote Breakdown</h5>
        <p><span style="color: #2563eb; font-weight: bold;">Democratic:</span> ${demPct.toFixed(1)}% (${demVotes.toLocaleString()})</p>
        <p><span style="color: #dc2626; font-weight: bold;">Republican:</span> ${repPct.toFixed(1)}% (${repVotes.toLocaleString()})</p>
      </div>
      <div class="competitiveness-section">
        <h5>🎯 Competitiveness</h5>
        <p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>
        ${marginPct <= 0.5 ? `<p style='color: #f59e0b; font-style: italic;'>(Extremely close!)</p>` : marginPct <= 1 ? `<p style='color: #f59e0b; font-style: italic;'>(Very close!)</p>` : ''}
      </div>
    `;
  } else {
    sidebarContent = `<p><em>No results found for this county in the selected contest.</em></p>`;
  }
  contentEl.innerHTML = sidebarContent;
  detailsDiv.style.display = 'block';
}

window.onload = init;

document.getElementById('contestSelect').addEventListener('change', function() {
  // If a county was previously selected, refresh its details for the new contest/year
  if (lastSelectedCounty) {
    showCountyDetails(lastSelectedCounty);
  }
});
</script>
</body>
</html>